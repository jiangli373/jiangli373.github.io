<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Mongodb副本集配置 | jiangli&#39;s blog</title>
  <meta name="author" content="jiangli">
  
  <meta name="description" content="测试配置MongoDB副本集，首先找3台测试服务器，或者一台服务器上，跑3个MongoDB实例也可以。我这里以3台服务器来做实验。
3台服务器IP
192.168.56.8192.168.56.9192.168.56.10
每台服务器上的MongoDB启动使用--replSet test 或者在mo">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Mongodb副本集配置"/>
  <meta property="og:site_name" content="jiangli&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="jiangli&#39;s blog" type="application/atom+xml">
    <link rel="stylesheet" href="http://apps.bdimg.com/libs/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="http://apps.bdimg.com/libs/fontawesome/4.0.3/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="http://apps.bdimg.com/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>

<body>
  <header id="header" class='normal_mode'>
    <nav id="main-nav">
  <ul class='container'>
    
      <li><a href="/">主页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
  </header>
  <div id="content" class="container">
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
      <time datetime="2018-09-05T03:37:00.000Z"><a href="/2018/09/05/副本集配置/">Wed, Sep 5 2018, 11:37:00 am</a></time>

  
    <h1 class="title">Mongodb副本集配置</h1>
  



  
  <div class="tags">
  	<i class="fa fa-tag"></i>
    <a href="/tags/MongoDB/">MongoDB</a>
  </div>

<div class="clear"></div>
      
    </header>
    <div class="entry">
      
        <p>测试配置MongoDB副本集，首先找3台测试服务器，或者一台服务器上，跑3个MongoDB实例也可以。我这里以3台服务器来做实验。</p>
<p>3台服务器IP</p>
<p>192.168.56.8<br>192.168.56.9<br>192.168.56.10</p>
<p>每台服务器上的MongoDB启动使用<code>--replSet test</code> 或者在mongodb.conf里面配置</p>
<p>例如：</p>
<p>mongodb.conf</p>
<p>  dbpath=/export/data/mongodb # 数据存放位置<br>  logpath=/export/data/mongodb/mongod.log # 日志存放位置<br>  replSet=jdcmofe       #副本集名称<br>  fork=true # 以后台模式运行</p>
<p>然后每台服务器按照这个命令启动</p>
<p>  mongod -f mongodb.conf</p>
<p>然后在任意一台服务器上执行如下操作:</p>
<p>我这里是在192.168.56.8服务器上操作</p>
<p>使用mongo shell登录mongodb，执行如下操作</p>
<p>  config={<br>    _id:”test”,<br>    members:[<br>      {_id:0,host:”192.168.56.8:27017”},<br>      {_id:1,host:”192.168.56.9:27017”},<br>      {_id:2,host:”192.168.56.10:27017”}<br>      ]<br>  };</p>
<p>_id是副本集名称</p>
<p>members是3台服务器的Ip</p>
<p>然后执行</p>
<p>  rs.initiate(config)</p>
<p>  rs.status() // 查看集群节点</p>
<h3 id="测试副本集的数据复制功能"><a href="#测试副本集的数据复制功能" class="headerlink" title="测试副本集的数据复制功能"></a>测试副本集的数据复制功能</h3><p>此时在我的机器上192.168.56.8是主节点，使用mongo shell登录mongodb</p>
<p>  use test  #切换到test数据库</p>
<p>  db.testdb.insert({“age”:1});       #插入数据</p>
<p>我们用副本节点登录shell，我这里是192.168.56.9</p>
<p>  use test<br>  show collections</p>
<p>此时会报错</p>
<p>  [thread1] Error: listCollections failed: {<br>  “ok” : 0,<br>  “errmsg” : “not master and slaveOk=false”,<br>  “code” : 13435,<br>  “codeName” : “NotMasterNoSlaveOk”<br>  }</p>
<p>因为mongodb默认是从主节点读写数据的，副本节点上不允许读，需要设置副本节点可以读。</p>
<p>  test:SECONDARY&gt; rs.slaveOk();</p>
<p>此时就可以读取数据了</p>
<p>  test:SECONDARY&gt; db.test.find();</p>
<p>控制台输出</p>
<p>  { “_id” : ObjectId(“59676d711881041abab44477”), “age” : 1 }</p>
<p>所以，数据复制的功能是可用的。</p>
<h2 id="MongoDB权限设置"><a href="#MongoDB权限设置" class="headerlink" title="MongoDB权限设置"></a>MongoDB权限设置</h2><p>默认MongoDB启动是不带权限校验的，所以都是在裸奔，需要加上权限校验。</p>
<p>首先使用mongo shell登录MongoDB数据库</p>
<p>  use admin;</p>
<p>  db.createUser(<br>    {<br>      user: “jiangli”,<br>      pwd: “123”,<br>      roles: [ { role: “userAdminAnyDatabase”, db: “admin” } ]<br>    }<br>  )</p>
<p>然后重新启动MongoDB</p>
<p>  mongod -f mongodb.conf –auth</p>
<p>–auth表示打开权限校验</p>
<p>我们刚才是在给admin数据库创建了用户，如果想给特定的数据库创建特定的用户可以按照下面的步骤</p>
<p>mongo shell登录数据库</p>
<p>  use admin<br>  db.auth(‘jiangli’, ‘123’)</p>
<p>  #切换到目标数据库上，比如test<br>  use test;<br>  db.createUser({user:”second”,pwd:”second”,roles: [ { role: “readWrite”, db: “test” } ]})</p>
<p>打开权限校验以后，副本集的启动也需要修改下。</p>
<p>Replica Set要使用keyFile的校验方式</p>
<p>首先在192.168.56.8服务器上生成key</p>
<p>  openssl rand -base64 756 &gt; <path-to-keyfile><br>  chmod 400 <path-to-keyfile></path-to-keyfile></path-to-keyfile></p>
<p>然后把生成key拷贝到其它两台服务器上去，然后更改下读取权限</p>
<p>  chmod 400 <path-to-keyfile></path-to-keyfile></p>
<p>然后重启MongoDB数据库</p>
<p>  mongod -f mongodb.conf –auth –keyFile=/export/data/mongodb/test-key</p>
<p>ps:</p>
<p>程序连接开启副本集，权限校验的MongoDB数据库方法</p>
<p>使用mongoose</p>
<p>方法一：</p>
<p>  const mongoose = require(‘mongoose’);<br>  mongoose.connect(<br>  ‘second:<a href="mailto:second@192.168.56.8" target="_blank" rel="noopener">second@192.168.56.8</a>:27017,192.168.56.9:27017,192.168.56.10:27017/test?replicaSet=test’</p>
<p>方法二:</p>
<p>如果你的数据库密码里面包含@ %等字符，如果使用方法一的方式，会报</p>
<p>  URIError: URI malformed<br>    at decodeURIComponent (<anonymous>)</anonymous></p>
<p>使用这种方式解决</p>
<p>  mongoose.connect(‘192.168.56.8:27017,192.168.56.9:27017,192.168.56.10:27017/test?replicaSet=test’,{user:’second’,pass:’second’,useMongoClient:true})</p>

      
    </div>
    <footer>
      
          
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <span class="jiathis_txt">分享到：</span>
  <a class="jiathis_button_weixin">微信</a>
  <a class="jiathis_button_tsina">新浪微博</a>
  <a class="jiathis_button_renren">人人网</a>
  <a class="jiathis_button_qzone">QQ空间</a>
  <a class="jiathis_button_douban">豆瓣</a>
  <a class="jiathis_button_pocket">Pocket</a>
  <a href="http://www.jiathis.com/share?uid=901656" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=901656" charset="utf-8"></script>
<!-- JiaThis Button END -->

          <div class="clearfix"></div>
          <nav id="pagination">
  
  
    <a href="/2018/08/17/Mongodb数据库介绍/" class="alignright next">Prev<i class="fa fa-long-arrow-right"></i></a>
  
  <div class="clearfix"></div>
</nav>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
      <!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-thread-key="/2018/09/05/副本集配置/"></div>
<!-- Duoshuo Comment END -->
  
</section>



    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div>
  
  &copy; 2018 jiangli
  
</div>
Powered by <a href="http://zespia.tw/hexo/" title="Hexo" target="_blank" rel="noopener">Hexo</a> and <a href="http://pages.github.com/" title="GitHub Pages" target="_blank" rel="noopener">GitHub Pages</a>

<div class="clearfix"></div></footer>
  
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




    <script type="text/javascript">
        (function(){

            $(window).scroll(function(){

                var scrollTop = $(window).scrollTop();
                if ( scrollTop >200 ){
                    $("#main-nav").removeClass('normal_mode').addClass('top_mode');
                } else{
                    $("#main-nav").removeClass('top_mode').addClass('normal_mode');
                }

            });

        })();
    </script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
  (function($){
    $('.fancybox').fancybox({
      'titlePosition': 'inside'
    });
  })(jQuery);
  </script>



    
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"nuonuo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = 'http://static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>



<script type="text/javascript">
  
  $(function(){

    $('.title').hover(
      function() {      
        $(this).stop().animate(
          {'marginLeft': '10px'}, 200
        );   
      }, 
      function() {       
        $(this).stop().animate({'marginLeft': '0px'}, 200);      
      
    });   

  });

</script>


</body>
</html>